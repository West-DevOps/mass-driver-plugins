"""Module for testing all the source components which talk to git sources."""
import httpx
from src.sources.gitlab import GitLabSearch


def test_gitlab_source(mocker) -> None:
    """
    Holy moly did I just mock something! :o

    Ben's turning a new leaf in testing!

    Args:
        mocker: The mocker fixture (pytest voodoo don't read into it too much!)

    Returns:
        None - it's a test!
    """
    mock_response_data = '[{"id":48350149,"description":"Inksacpe extension to transform an DHL shipping label (A4, PDF) to a Brother compatible label (180mm x 62mm).\\r\\n\\r\\nInstall plugin, reload Inkscape and open PDF file, run  \\"Extensions/Tools/DHL Label\\".","name":"Inkscape DHL Label","name_with_namespace":"Benedikt Neuffer / Inkscape DHL Label","path":"inkscape-dhl-label","path_with_namespace":"ogelpre/inkscape-dhl-label","created_at":"2023-08-08T19:27:52.225Z","default_branch":"main","tag_list":["Brother QL-500","Brother QL-570","Brother QL-700","DHL shipping label"],"topics":["Brother QL-500","Brother QL-570","Brother QL-700","DHL shipping label"],"ssh_url_to_repo":"git@gitlab.com:ogelpre/inkscape-dhl-label.git","http_url_to_repo":"https://gitlab.com/ogelpre/inkscape-dhl-label.git","web_url":"https://gitlab.com/ogelpre/inkscape-dhl-label","readme_url":null,"forks_count":0,"avatar_url":null,"star_count":0,"last_activity_at":"2023-08-08T19:27:52.225Z","namespace":{"id":504629,"name":"Benedikt Neuffer","path":"ogelpre","kind":"user","full_path":"ogelpre","parent_id":null,"avatar_url":"https://secure.gravatar.com/avatar/9abef4a251d68ee6a3fac8fd65c9501978db0128577e27b94b71599394755b4f?s=80\\u0026d=identicon","web_url":"https://gitlab.com/ogelpre"}},{"id":40442407,"description":"The all new Gnome Inkscape \\"artificially intelligent\\" (AI) \\"red green blue\\" (RGB) effects plugin.","name":"gnome-inkscape-ai-rgb-effects","name_with_namespace":"Timothy Bergstresser / gnome-inkscape-ai-rgb-effects","path":"effects-plugin","path_with_namespace":"armbiant/effects-plugin","created_at":"2022-10-22T16:01:54.771Z","default_branch":"master","tag_list":[],"topics":[],"ssh_url_to_repo":"git@gitlab.com:armbiant/effects-plugin.git","http_url_to_repo":"https://gitlab.com/armbiant/effects-plugin.git","web_url":"https://gitlab.com/armbiant/effects-plugin","readme_url":"https://gitlab.com/armbiant/effects-plugin/-/blob/master/README.md","forks_count":0,"avatar_url":"https://gitlab.com/uploads/-/system/project/avatar/40442407/OpenRGB_EffectsEngine.png","star_count":0,"last_activity_at":"2024-06-25T14:20:24.382Z","namespace":{"id":57251152,"name":"Timothy Bergstresser","path":"armbiant","kind":"user","full_path":"armbiant","parent_id":null,"avatar_url":"/uploads/-/system/user/avatar/12409936/avatar.png","web_url":"https://gitlab.com/armbiant"}},{"id":29429926,"description":"Inkscape plugin to clip a background image by object outlines then export to multiple png. ","name":"Clip Out","name_with_namespace":"Inklinea / Clip Out","path":"clip-out","path_with_namespace":"inklinea/clip-out","created_at":"2021-09-07T14:33:21.532Z","default_branch":"main","tag_list":[],"topics":[],"ssh_url_to_repo":"git@gitlab.com:inklinea/clip-out.git","http_url_to_repo":"https://gitlab.com/inklinea/clip-out.git","web_url":"https://gitlab.com/inklinea/clip-out","readme_url":"https://gitlab.com/inklinea/clip-out/-/blob/main/README.md","forks_count":0,"avatar_url":null,"star_count":0,"last_activity_at":"2022-10-24T04:20:05.355Z","namespace":{"id":10687380,"name":"Inklinea","path":"inklinea","kind":"user","full_path":"inklinea","parent_id":null,"avatar_url":"/uploads/-/system/user/avatar/8017810/avatar.png","web_url":"https://gitlab.com/inklinea"}},{"id":19500038,"description":"A simple plugin to convert inkscape vector graphics to Gcode for DIY laser engravers","name":"Inkscape-Lasertools-Plugin","name_with_namespace":"George Farris / Inkscape-Lasertools-Plugin","path":"Inkscape-Lasertools-Plugin","path_with_namespace":"horga83/Inkscape-Lasertools-Plugin","created_at":"2020-06-20T20:44:34.473Z","default_branch":"master","tag_list":[],"topics":[],"ssh_url_to_repo":"git@gitlab.com:horga83/Inkscape-Lasertools-Plugin.git","http_url_to_repo":"https://gitlab.com/horga83/Inkscape-Lasertools-Plugin.git","web_url":"https://gitlab.com/horga83/Inkscape-Lasertools-Plugin","readme_url":"https://gitlab.com/horga83/Inkscape-Lasertools-Plugin/-/blob/master/README.md","forks_count":0,"avatar_url":null,"star_count":0,"last_activity_at":"2020-06-20T20:44:34.473Z","namespace":{"id":7473833,"name":"George Farris","path":"horga83","kind":"user","full_path":"horga83","parent_id":null,"avatar_url":"https://secure.gravatar.com/avatar/d4a8fef73eb3dd2ecfc016d5e757845460272ca37427826baa9782c88d0b0c9e?s=80\\u0026d=identicon","web_url":"https://gitlab.com/horga83"}},{"id":15556665,"description":null,"name":"Inkscape-Plugins","name_with_namespace":"Andrew Dobson / Inkscape-Plugins","path":"Inkscape-Plugins","path_with_namespace":"Magdes/Inkscape-Plugins","created_at":"2019-11-27T03:50:45.266Z","default_branch":"master","tag_list":[],"topics":[],"ssh_url_to_repo":"git@gitlab.com:Magdes/Inkscape-Plugins.git","http_url_to_repo":"https://gitlab.com/Magdes/Inkscape-Plugins.git","web_url":"https://gitlab.com/Magdes/Inkscape-Plugins","readme_url":"https://gitlab.com/Magdes/Inkscape-Plugins/-/blob/master/README.md","forks_count":0,"avatar_url":null,"star_count":0,"last_activity_at":"2019-11-27T03:50:45.266Z","namespace":{"id":716178,"name":"Andrew Dobson","path":"Magdes","kind":"user","full_path":"Magdes","parent_id":null,"avatar_url":"/uploads/-/system/user/avatar/602468/avatar.png","web_url":"https://gitlab.com/Magdes"}},{"id":14152510,"description":"Plugin for inkscape to generate gcode from paths.","name":"Yet Another Inkscape Plugin for Gcode","name_with_namespace":"Fitz Terra / Yet Another Inkscape Plugin for Gcode","path":"yaip4g","path_with_namespace":"fitzterra/yaip4g","created_at":"2019-09-05T04:03:45.470Z","default_branch":"master","tag_list":[],"topics":[],"ssh_url_to_repo":"git@gitlab.com:fitzterra/yaip4g.git","http_url_to_repo":"https://gitlab.com/fitzterra/yaip4g.git","web_url":"https://gitlab.com/fitzterra/yaip4g","readme_url":"https://gitlab.com/fitzterra/yaip4g/-/blob/master/README.md","forks_count":0,"avatar_url":null,"star_count":0,"last_activity_at":"2019-09-05T05:54:51.876Z","namespace":{"id":4911485,"name":"Fitz Terra","path":"fitzterra","kind":"user","full_path":"fitzterra","parent_id":null,"avatar_url":"https://secure.gravatar.com/avatar/a337bbbb751ac8b80f3ff2a55a169ff718f87b62256eeabe4758218c52a677ae?s=80\\u0026d=identicon","web_url":"https://gitlab.com/fitzterra"}},{"id":7499333,"description":"Analysis_stroke is an inkscape plugin for calculate the radius of a stroke","name":"analysis_stroke","name_with_namespace":"jeremy / analysis_stroke","path":"analysis_stroke","path_with_namespace":"Jeremy.Chardon/analysis_stroke","created_at":"2018-07-16T00:36:36.010Z","default_branch":"master","tag_list":[],"topics":[],"ssh_url_to_repo":"git@gitlab.com:Jeremy.Chardon/analysis_stroke.git","http_url_to_repo":"https://gitlab.com/Jeremy.Chardon/analysis_stroke.git","web_url":"https://gitlab.com/Jeremy.Chardon/analysis_stroke","readme_url":null,"forks_count":0,"avatar_url":null,"star_count":0,"last_activity_at":"2018-07-16T00:36:36.010Z","namespace":{"id":3100510,"name":"jeremy","path":"Jeremy.Chardon","kind":"user","full_path":"Jeremy.Chardon","parent_id":null,"avatar_url":"https://secure.gravatar.com/avatar/b0685670c3fcf8dfaf13fc225304b207a324a546bbf6a99a8e8221ce9e3d8503?s=80\\u0026d=identicon","web_url":"https://gitlab.com/Jeremy.Chardon"}},{"id":6777963,"description":"Collection de plugin inkscape utiles dans un fablab","name":"fablab-inkscape-plugins","name_with_namespace":"Olliver Schinagl / fablab-inkscape-plugins","path":"fablab-inkscape-plugins","path_with_namespace":"olliver.schinagl/fablab-inkscape-plugins","created_at":"2018-06-05T08:04:59.855Z","default_branch":"master","tag_list":[],"topics":[],"ssh_url_to_repo":"git@gitlab.com:olliver.schinagl/fablab-inkscape-plugins.git","http_url_to_repo":"https://gitlab.com/olliver.schinagl/fablab-inkscape-plugins.git","web_url":"https://gitlab.com/olliver.schinagl/fablab-inkscape-plugins","readme_url":"https://gitlab.com/olliver.schinagl/fablab-inkscape-plugins/-/blob/master/README.md","forks_count":0,"avatar_url":null,"star_count":0,"last_activity_at":"2018-06-05T08:04:59.855Z","namespace":{"id":2961993,"name":"Olliver Schinagl","path":"olliver.schinagl","kind":"user","full_path":"olliver.schinagl","parent_id":null,"avatar_url":"https://secure.gravatar.com/avatar/abb8ef5f9b23563b7703a4114da6f9bd6e7f6d7e8e0296677547b20ff7740c56?s=80\\u0026d=identicon","web_url":"https://gitlab.com/olliver.schinagl"}}]'
    mock_response = httpx.Response(status_code=200, text=mock_response_data, headers={})
    mocker.patch('src.sources.gitlab.GITLAB_CLIENT.get', return_value=mock_response)

    gls = GitLabSearch(api_root="https://gitlab.com/api/v4", search_query="inkscape+plugin", clone_mode="http")
    indexed_repos = gls.discover()

    assert isinstance(indexed_repos, dict), "discover() should return a dictionary"
    assert len(indexed_repos) == 8, "Should have gotten 8 IndexedRepos"
    assert indexed_repos.keys().__contains__('Inkscape DHL Label'), "Should have found key 'Inkscape DHL Label'"
